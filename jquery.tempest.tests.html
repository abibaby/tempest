<html>
    <body>

        <textarea class="tempest-template" title="template-message" style="display:none;">
            <li>{{name}} says "{{message}}"</li>
        </textarea>
        <textarea class="tempest-template" title="template-web-things" style="display:none;">
            <li>{{name}} is a {{type}} at {{url}}</li>
        </textarea>
        <textarea class="tempest-template" title="if-template" style="display:none;">
            <li>hello {% if t %}world{% endif %}</li>
        </textarea>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
        <script type="text/javascript" src="jquery.tempest.js"></script>
        <script type="text/javascript">
        $(document).ready(function(){

            function testStorageFromTextarea(){
                var templ1 = $.tempest("template-message") == "<li>{{name}} says \"{{message}}\"</li>";
                var templ2 = $.tempest("template-web-things") == "<li>{{name}} is a {{type}} at {{url}}</li>";
                return templ1 == true && templ2 == true;
            }
            fireunit.ok(testStorageFromTextarea(), "Access stored templates that were inside textareas");

            function testGetAllTemplatesLength(){
                return $.tempest().length == 3;
            }
            fireunit.ok(testGetAllTemplatesLength(), "Length of $.tempest() is equal to number of textarea templates pre-defined");

            function testGetAllTemplatesKeys(){
                var first = $.tempest()[0];
                var second = $.tempest()[1];
                var first_correct = first[0] == "template-message" || first[0] == "template-web-things";
                var second_correct = second[0] == "template-message" || second[0] == "template-web-things";
                return first_correct && second_correct && first[0] != second[0];
            }
            fireunit.ok(testGetAllTemplatesKeys(), "Keys to existing templates are in $.tempest()");

            function testGetAllTemplatesVals(){
                var first = $.tempest()[0];
                var second = $.tempest()[1];
                var first_correct = first[1] == $.tempest("template-message") || first[1] == $.tempest("template-web-things");
                var second_correct = second[1] == $.tempest("template-message") || second[1] == $.tempest("template-web-things");
                return first_correct && second_correct && first[1] != second[1];
            }
            fireunit.ok(testGetAllTemplatesVals(), "Existing templates are in $.tempest()");

            function testSetTemplate(){
                var tmpl = "Hello {{variable}}";
                return $.tempest("hello", tmpl) == tmpl;
            }
            fireunit.ok(testSetTemplate(), "Template setter");

            function testGetTemplate(){
                var key = "arbitrary";
                var tmpl = "Hello {{variable}}";
                $.tempest(key, tmpl);
                return $.tempest(key) == tmpl;
            }
            fireunit.ok(testGetTemplate(), "Template getter");

            function testRenderedValue(){
                var obj = {"name":"my site", "type":"blog", "url":"http://fitzgeraldnick.com/"};
                var rendered = $.tempest("template-web-things", obj);
                return rendered.text() == "my site is a blog at http://fitzgeraldnick.com/";
            }
            fireunit.ok(testRenderedValue(), "The text of the rendered template is correct");

            function testAppendSingleObject(){
                var len = $("body ul li").length;
                var message = {name:"nick", message:"hello world"};
                var rendered = $.tempest("template-message", message);
                $("body ul").append(rendered);
                return len + 1 == $("body ul li").length;
            }
            fireunit.ok(testAppendSingleObject(), "Append a single rendered object to the DOM");

            function testManyRenderedValue(){
                var arr = [{name:"mom", message:"brush your teeth"},
                           {name:"heidi", message:"why hello"},
                           {name:"bill clinton", message:"I didn't inhale"},
                           {name:"OJ and Brittany", message:"Oops I did it again"},];
                var text = $.tempest("template-message", arr).text();

                var expected = [];
                for (i = 0; i < arr.length; i++){
                    expected.push($.tempest("template-message", arr[i]).text());
                }
                expected = expected.join("");
                return text == expected;
            }
            fireunit.ok(testManyRenderedValue(), "The text of the rendered template is correct with array of objs");

            function testAppendManyObjects(){
                var len = $("body ul li").length;
                var arr = [{name:"mom", message:"brush your teeth"},
                           {name:"heidi", message:"why hello"},
                           {name:"bill clinton", message:"I didn't inhale"},
                           {name:"OJ and Brittany", message:"Oops I did it again"},];
                var rendered = $.tempest("template-message", arr);
                $("body ul").append(rendered);
                return len + arr.length == $("body ul li").length;
            }
            fireunit.ok(testAppendManyObjects(), "Append an array of rendered objects to the DOM");

            function testRenderOneTimeUseTemplate(){
                var obj = {thing:"test", activity:"TESTS"};
                var tmpl = "<li><em>Whoah a one time use {{thing}} for doing {{activity}}</em></li>";
                var rendered = $.tempest(tmpl, obj);
                return rendered.text() == "Whoah a one time use test for doing TESTS";
            }
            fireunit.ok(testRenderOneTimeUseTemplate(), "Render data to a one-time-use template");

            function testAppendOneTimeUseTemplate(){
                var len = $("body ul li").length;
                var obj = {thing:"test", activity:"TESTS"};
                var tmpl = "<li><em>Whoah a one time use {{thing}} for doing {{activity}}</em></li>";
                var rendered = $.tempest(tmpl, obj);
                $("body ul").append(rendered);
                return len + 1 == $("body ul li").length;
            }
            fireunit.ok(testAppendOneTimeUseTemplate(), "Append data from a rendered one-time-use template");

            function testUnknownInput(){
                try {
                    $.tempest(3242354534534);
                    return false;
                } catch(error) {
                    return true;
                }
            }
            fireunit.ok(testUnknownInput(), "Unknown input throws an error");

            function testRenderJQuery() {
                var jq = "<div>jQuery object</div>";
                var rendered = $.tempest("template-message", {
                    name: "nick",
                    message: $(jq),
                });
                return rendered.html() == 'nick says "'+jq+'"';
            }
            fireunit.ok(testRenderJQuery(), "Render jQuery objects with their HTML");

            function testEmptyObjRendersEmptyStr() {
                var tmpl = "<p>{{ non-existent }}</p>";
                var obj = {};
                return $.tempest(tmpl, obj).text() === "";
            }
            fireunit.ok(testEmptyObjRendersEmptyStr(), "If a template's variable is not passed, default that variable to \"\"");

            function testAccessObjectAttrs() {
                var obj = {
                    obj: { name:"object", type: { attr: "attribute" } }
                };
                var tmpl = "<p>{{ obj.name }} {{ obj.type.attr }}</p>";
                var rendered = $.tempest(tmpl, obj);
                return rendered.text() === "object attribute";
            }
            fireunit.ok(testAccessObjectAttrs(), "Access a passed object's attributes");

            function testToHTML() {
                var obj = {
                    obj: { toHTML: function () { return "Hello World" } }
                };
                var tmpl = "<p>{{ obj }}</p>";
                var rendered = $.tempest(tmpl, obj);
                return rendered.text() === "Hello World";
            }
            fireunit.ok(testToHTML(), "If an object is passed as a variable, render it with the toHTML method if it exists.");

            // evaluate all the tests
            fireunit.testDone();



            // speed monitoring ========================================================================

            // see how long it takes to render 100 templates 20 times
            var deltas = [];
            var count = 0;
            $("body ul:last").after("<h3>Rendering a template 1000 times:</h3><ul></ul><p></p>");

            setTimeout(function () {
                // show a little something so we know that the tests haven't stalled
                var last_p = $("p:last");
                last_p.html(last_p.html()+". ");

                if (count < 1000) {
                    var start = new Date().getTime();
                    $.tempest("<li><em>Whoah a one time use {{thing}}!</em></li>", {
                        thing: "test"
                    });
                    var end = new Date().getTime();
                    var delta = end - start;
                    deltas.push(delta);

                    // recur
                    count++;
                    return setTimeout(arguments.callee, 1);
                } else {
                    return calcSpeedStats();
                }
            }, 1);

            function calcSpeedStats() {
                $("p:last").hide();
                // avg (mean)
                var total = 0;
                for (i = 0; i < deltas.length; i++) {
                    total += deltas[i];
                }
                var avg = total / deltas.length;

                // std deviation
                var diffs = [];
                for (i = 0; i < deltas.length; i++) {
                    diffs[i] = (deltas[i] - avg) * (deltas[i] - avg);
                }
                var stdDevTotal = 0;
                for (i = 0; i < diffs.length; i++) {
                    stdDevTotal += diffs[i];
                }
                var stdDev = Math.sqrt(stdDevTotal / diffs.length);

                var max = Math.max.apply(Math, deltas);
                var min = Math.min.apply(Math, deltas);

                $("body ul:last").append("<li>The avg. time was "+avg+" ms</li>")
                $("body ul:last").append("<li>The standard deviation was "+stdDev+" ms</li>")
                $("body ul:last").append("<li>The max time was "+max+" ms</li>")
                $("body ul:last").append("<li>The min time was "+min+" ms</li>")
            }


        });
        </script>

        <ul>
        </ul>
    </body>
</html>
